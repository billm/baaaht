# File Delegation Example

**Assistant Delegates File Operations to Worker Agent**

This example demonstrates the Assistant Agent delegating file operations to the Worker agent using the `delegate` tool. The Assistant never directly accesses the filesystem — all file operations are performed by the Worker.

---

## Scenario

A user wants to read a configuration file and then write an updated version. The Assistant delegates both the read and write operations to the Worker agent.

---

## Conversation Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    File Delegation Flow                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  User ──▶ Orchestrator ──▶ Assistant Agent                     │
│                                  │                              │
│                                  ▼                              │
│                         LLM Gateway                             │
│                                  │                              │
│                        [needs file data]                       │
│                                  │                              │
│                                  ▼                              │
│  Assistant invokes delegate tool ──▶ Orchestrator              │
│                                          │                      │
│                                          ▼                      │
│                                    Worker Agent                 │
│                                          │                      │
│                                    [reads file]                 │
│                                          │                      │
│                                          ▼                      │
│  Result ──▶ Orchestrator ──▶ Assistant Agent                   │
│                                  │                              │
│                                  ▼                              │
│                         LLM Gateway                             │
│                                  │                              │
│                        [generates update]                       │
│                                  │                              │
│                                  ▼                              │
│  Assistant invokes delegate tool ──▶ Orchestrator              │
│                                          │                      │
│                                          ▼                      │
│                                    Worker Agent                 │
│                                          │                      │
│                                    [writes file]                │
│                                          │                      │
│                                          ▼                      │
│  User ◀── Orchestrator ◀── Assistant Agent                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Message Exchange

### Step 1: User sends message

**User Message:**
```json
{
  "id": "msg-001",
  "sessionId": "session-file-ops",
  "content": "Please read /etc/app/config.json and update the timeout setting from 30 to 60 seconds.",
  "type": "MESSAGE_TYPE_USER",
  "timestamp": "2026-02-10T14:22:00Z"
}
```

### Step 2: Assistant determines delegation needed

The LLM analyzes the request and determines:
1. Need to read `/etc/app/config.json` → requires `delegate` with `read_file`
2. Need to write updated content → requires `delegate` with `write_file`

### Step 3: Assistant calls delegate tool (read)

**Tool Call Generated by LLM:**
```json
{
  "toolCallId": "tool-001",
  "name": "delegate",
  "input": {
    "target": "worker",
    "operation": "read_file",
    "parameters": {
      "path": "/etc/app/config.json",
      "offset": 0,
      "limit": 10240
    },
    "timeout": 30000
  }
}
```

### Step 4: Assistant executes delegation

```typescript
// src/agent/tool-calling.ts - ToolCallExecutor
const executor = new ToolCallExecutor({
  grpcClient: this.grpcClient,
  sessionManager: this.sessionManager,
});

// Execute delegation
const result = await executor.executeToolCall(
  {
    id: 'tool-001',
    name: 'delegate',
    input: { /* ... */ },
  },
  'session-file-ops'
);
```

### Step 5: Worker agent executes read operation

```typescript
// Worker agent receives task via Orchestrator
interface TaskConfig {
  command: 'read_file';
  arguments: ['/etc/app/config.json', '--offset=0', '--limit=10240'];
  environment: {
    TASK_ID: 'task-read-001',
    SESSION_ID: 'session-file-ops',
  };
  timeout: 30000;
}

// Worker reads file and returns result
interface TaskResult {
  success: true;
  output: '{\n  "timeout": 30,\n  "retries": 3,\n  "debug": false\n}';
  state: TaskState.TASK_STATE_COMPLETED;
}
```

### Step 6: Assistant receives file content and processes

```typescript
// Delegation result returned to Assistant
interface DelegateResult {
  success: true,
  taskId: 'task-read-001',
  taskState: TaskState.TASK_STATE_COMPLETED,
  data: {
    content: '{\n  "timeout": 30,\n  "retries": 3,\n  "debug": false\n}',
    path: '/etc/app/config.json',
    size: 52
  },
  metadata: {
    target: DelegateTarget.WORKER,
    operation: DelegateOperation.READ_FILE,
    createdAt: new Date('2026-02-10T14:22:01Z'),
    completedAt: new Date('2026-02-10T14:22:01.500Z'),
    duration: 500,
    agentId: 'worker-001'
  }
}

// Result is added to conversation as tool result
{
  "toolCallId": "tool-001",
  "content": '{"success":true,"data":{"content":"{...}"}}',
  "isError": false
}
```

### Step 7: LLM generates updated content

The LLM receives the file content, updates the timeout, and prepares to write:

```typescript
// LLM generates second tool call
{
  "toolCallId": "tool-002",
  "name": "delegate",
  "input": {
    "target": "worker",
    "operation": "write_file",
    "parameters": {
      "path": "/etc/app/config.json",
      "content": "{\n  \"timeout\": 60,\n  \"retries\": 3,\n  \"debug\": false\n}",
      "createParents": false
    },
    "timeout": 30000
  }
}
```

### Step 8: Assistant executes write delegation

```typescript
// Execute write operation
const writeResult = await executor.executeToolCall(
  {
    id: 'tool-002',
    name: 'delegate',
    input: { /* ... */ },
  },
  'session-file-ops'
);
```

### Step 9: Worker agent executes write operation

```typescript
// Worker writes file
interface TaskResult {
  success: true;
  output: '{"written":52,"path":"/etc/app/config.json"}';
  state: TaskState.TASK_STATE_COMPLETED;
}
```

### Step 10: Assistant responds to user

**Assistant Response:**
```json
{
  "id": "msg-002",
  "sessionId": "session-file-ops",
  "content": "I've successfully updated the configuration file. Here's what I did:\n\n1. **Read** `/etc/app/config.json`\n2. **Updated** timeout from 30 to 60 seconds\n3. **Wrote** the updated configuration back to the file\n\nThe configuration has been saved with the new timeout value of 60 seconds.",
  "type": "MESSAGE_TYPE_ASSISTANT",
  "toolCalls": [
    {
      "id": "tool-001",
      "name": "delegate",
      "input": {
        "target": "worker",
        "operation": "read_file",
        "parameters": {
          "path": "/etc/app/config.json",
          "offset": 0,
          "limit": 10240
        },
        "timeout": 30000
      },
      "result": {
        "success": true,
        "data": {
          "content": "{\n  \"timeout\": 30,\n  \"retries\": 3,\n  \"debug\": false\n}",
          "path": "/etc/app/config.json",
          "size": 52
        }
      },
      "durationMs": 500
    },
    {
      "id": "tool-002",
      "name": "delegate",
      "input": {
        "target": "worker",
        "operation": "write_file",
        "parameters": {
          "path": "/etc/app/config.json",
          "content": "{\n  \"timeout\": 60,\n  \"retries\": 3,\n  \"debug\": false\n}",
          "createParents": false
        },
        "timeout": 30000
      },
      "result": {
        "success": true,
        "data": {
          "written": 52,
          "path": "/etc/app/config.json"
        }
      },
      "durationMs": 300
    }
  ],
  "timestamp": "2026-02-10T14:22:03Z",
  "usage": {
    "inputTokens": 180,
    "outputTokens": 150,
    "totalTokens": 330
  }
}
```

---

## Session State After Conversation

```typescript
{
  id: "session-file-ops",
  state: SessionState.SESSION_STATE_ACTIVE,
  messages: [
    {
      id: "msg-001",
      role: MessageRole.MESSAGE_ROLE_USER,
      content: "Please read /etc/app/config.json and update...",
      timestamp: new Date("2026-02-10T14:22:00Z"),
    },
    {
      // Assistant message with tool calls
      id: "msg-002",
      role: MessageRole.MESSAGE_ROLE_ASSISTANT,
      content: "I've successfully updated the configuration file...",
      toolCalls: [ /* ... */ ],
      timestamp: new Date("2026-02-10T14:22:03Z"),
    }
  ],
  metadata: {
    createdAt: new Date("2026-02-10T14:22:00Z"),
    lastActivityAt: new Date("2026-02-10T14:22:03Z"),
    messageCount: 2,
    totalTokens: 330,
    delegationCount: 2,  // Two delegations performed
    delegationTargets: ['worker', 'worker'],
  }
}
```

---

## Tool Call Details

### Tool Definition (as registered with LLM)

```typescript
{
  name: 'delegate',
  description: 'Delegate an operation to a specialized agent. Use this tool when the user request requires file operations, web operations, research, or code execution that you cannot perform directly.',
  inputSchema: {
    type: 'object',
    properties: {
      target: {
        type: 'string',
        enum: ['worker', 'researcher', 'coder'],
        description: 'The target agent for delegation',
      },
      operation: {
        type: 'string',
        enum: [
          'read_file', 'write_file', 'delete_file',
          'list_files', 'search_files',
          'web_search', 'web_fetch',
          // ... more operations
        ],
        description: 'The operation to perform',
      },
      parameters: {
        type: 'object',
        description: 'Operation-specific parameters',
      },
      timeout: {
        type: 'number',
        description: 'Optional timeout in milliseconds (default: 60000)',
      },
    },
    required: ['target', 'operation', 'parameters'],
  },
}
```

### Read File Operation Parameters

```typescript
interface ReadFileParams {
  path: string;           // Absolute or relative path to file
  offset?: number;        // Byte offset to start reading (default: 0)
  limit?: number;         // Maximum bytes to read (default: 102400)
}
```

### Write File Operation Parameters

```typescript
interface WriteFileParams {
  path: string;           // Absolute or relative path to file
  content: string;        // Content to write
  createParents?: boolean;  // Create parent directories if needed
}
```

---

## Event Timeline

| Time | Event | Duration |
|---|---|---|
| 14:22:00.000 | User message received | — |
| 14:22:00.100 | LLM completion (generates read_file) | 100ms |
| 14:22:00.100 | Delegation to Worker (read_file) | — |
| 14:22:00.600 | Worker completes file read | 500ms |
| 14:22:00.700 | LLM completion (processes content, generates write) | 100ms |
| 14:22:00.700 | Delegation to Worker (write_file) | — |
| 14:22:01.000 | Worker completes file write | 300ms |
| 14:22:01.100 | LLM completion (final response) | 100ms |
| 14:22:01.100 | Response sent to user | — |
| **Total** | **End-to-end latency** | **~1.1 seconds** |

---

## Key Observations

| Aspect | What Happened |
|---|---|
| **Tool Usage** | `delegate` tool invoked twice (read_file, write_file) |
| **Delegation** | Both delegations to Worker agent |
| **Session Context** | Updated with user message, assistant response, and tool results |
| **Assistant Context** | Clean — contains only conversation and delegation summaries |
| **Worker Context** | Contains full tool execution traces (isolated from Assistant) |
| **Response Time** | ~1.1 seconds total (2 LLM calls + 2 delegations) |

---

## Security Considerations

1. **Path Validation**: Worker validates all file paths before execution
2. **Permission Checks**: Worker checks file system permissions
3. **Sandbox**: Worker operates within restricted directory (if configured)
4. **Audit Trail**: All delegations logged with task IDs and timestamps

---

## Error Handling Examples

### File Not Found

```json
{
  "success": false,
  "taskId": "task-read-002",
  "taskState": "TASK_STATE_FAILED",
  "error": "File not found: /etc/app/missing.json",
  "metadata": { /* ... */ }
}
```

### Permission Denied

```json
{
  "success": false,
  "taskId": "task-write-003",
  "taskState": "TASK_STATE_FAILED",
  "error": "Permission denied: /root/config.json (read-only filesystem)",
  "metadata": { /* ... */ }
}
```

### Timeout

```json
{
  "success": false,
  "taskId": "task-read-004",
  "taskState": "TASK_STATE_TIMEOUT",
  "error": "Operation timed out after 30000ms",
  "metadata": { /* ... */ }
}
```

---

## Related Examples

- [`simple-chat.md`](./simple-chat.md) — Direct response without delegation
- [`web-search.md`](./web-search.md) — Web operation delegation

---

## Code Reference

See [`docs/DELEGATION.md`](../docs/DELEGATION.md) for:
- Complete delegate tool specification
- All supported operations and parameters
- Validation and error handling
- Timeout and priority handling

---

**Copyright © 2026 baaaht project**
